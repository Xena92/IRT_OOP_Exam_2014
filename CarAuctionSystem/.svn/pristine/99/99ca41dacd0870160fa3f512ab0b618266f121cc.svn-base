using System;
using System.Collections.Generic;

namespace CarAuctionSystem
{
    /// <summary>
    /// Base class for any person or company who wishes to trade
    /// </summary>
    public abstract class Trader : IEquatable<Trader>
    {
        public virtual bool Equals(Trader other)
        {
            if (ReferenceEquals(null, other)) return false;
            if (ReferenceEquals(this, other)) return true;
            return ZipCode == other.ZipCode;
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj)) return false;
            if (ReferenceEquals(this, obj)) return true;
            if (obj.GetType() != this.GetType()) return false;
            return Equals((Trader) obj);
        }

        public override int GetHashCode()
        {
            return (int) ZipCode;
        }

        private readonly Dictionary<Vehicle, decimal> _expectedPayments;


        /// <summary>
        /// The balance fo the trader
        /// </summary>
        protected decimal balance;

        /// <summary>
        /// Initializes a new instance of the <see cref="Trader"/> class.
        /// </summary>
        /// <param name="balance">The balance of the trader.</param>
        /// <param name="zip">The zip code of the location of the trader.</param>
        protected Trader(decimal balance, uint zip)
        {
            ZipCode = zip;
            this.balance = balance;
            _expectedPayments = new Dictionary<Vehicle, decimal>();
        }

        /// <summary>
        /// Gets the zip code.
        /// </summary>
        /// <value>
        /// The zip code.
        /// </value>
        public uint ZipCode { get; private set; }

        /// <summary>
        /// Gets the balance.
        /// </summary>
        /// <value>
        /// The balance.
        /// </value>
        public virtual decimal Balance
        {
            get { return balance; }
        }

        /// <summary>
        /// Notifies the <see cref="Trader"/> about a offer.
        /// </summary>
        /// <param name="sender">The sender.</param>
        /// <param name="e">The <see cref="EventArgs"/> instance containing the event data.</param>
        public void NotifyAboutOffer(object sender, EventArgs e)
        {
            var eventArgs = e as OfferEventArgs;

            _expectedPayments[eventArgs.Vehicle] = eventArgs.Price - eventArgs.Fees;

            Console.WriteLine("Someone bid on your {0} with registration number {1}. The price is now on {2}.",
                eventArgs.Vehicle.Name, eventArgs.Vehicle.RegNumber, eventArgs.Price);
        }

        /// <summary>
        /// Executes a payment.
        /// </summary>
        /// <remarks>
        /// Only planned payments are allowed to be executed.
        /// This works for both selling and buying, the money amount just has to reflect that.
        /// </remarks>
        /// <param name="money">The money in the payment.</param>
        /// <param name="product">The product.</param>
        /// <returns>returns <c>true</c> if the execution was sucessful; otherwise false</returns>
        public bool ExecutePayment(decimal money, Vehicle product)
        {
            decimal payment;
            _expectedPayments.TryGetValue(product, out payment);

            if (payment != money || Balance < payment)
                return false;

            balance += money;
            _expectedPayments.Remove(product);
            return true;
        }

        /// <summary>
        /// Notifies the <see cref="Trader"/> when their offer is overridden.
        /// </summary>
        /// <param name="vehicle">The vehicle that the trader is trying to buy.</param>
        public void NotifyOfferOverridden(Vehicle vehicle)
        {
            _expectedPayments.Remove(vehicle);
        }

        /// <summary>
        /// Notifies the <see cref="Trader"/> when their offer is accepted.
        /// </summary>
        /// <remarks>
        /// This doesn't meant that other bidders may not bid.
        /// </remarks>
        /// <param name="vehicle">The vehicle that is being sold.</param>
        /// <param name="offer">The accepted offer.</param>
        public void NotifyOfferAccepted(Vehicle vehicle, decimal offer)
        {
            _expectedPayments[vehicle] = -offer;
        }

        /// <summary>
        /// Implements the operator ==.
        /// </summary>
        /// <param name="trader1">The lefthand side trader.</param>
        /// <param name="trader2">The righthand side trader.</param>
        /// <returns>
        /// The result of the operator.
        /// </returns>
        public static bool operator ==(Trader trader1, Trader trader2)
        {
            return trader1.Equals(trader2);
        }

        /// <summary>
        /// Implements the operator !=.
        /// </summary>
        /// <param name="trader1">The lefthand side trader.</param>
        /// <param name="trader2">The righthand side trader.</param>
        /// <returns>
        /// The result of the operator.
        /// </returns>
        public static bool operator !=(Trader trader1, Trader trader2)
        {
            return !(trader1 == trader2);
        }
    }
}